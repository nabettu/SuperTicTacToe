rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 部屋に関するルール - 認証を必要としない
    match /rooms/{roomId} {
      // 読み取り: 誰でも可能
      allow get, list: if true;
      
      // 作成: 誰でも可能
      allow create: if request.resource.data.hostId is string &&
                     request.resource.data.status == 'waiting';
      
      // 更新: 以下の条件で更新可能
      // 1. 部屋のホストかゲストである、またはゲストIDがまだ設定されていない場合に新規参加
      // 2. 重要なフィールド（hostId）が変更されていない
      allow update: if (
                       // ホストかゲストによる更新
                       (resource.data.hostId == request.resource.data.hostId && 
                        (resource.data.hostId == request.resource.data.hostId || 
                         resource.data.guestId == request.resource.data.guestId)) ||
                       // 新規ゲスト参加（waiting状態でゲストIDが未設定の場合）
                       (resource.data.guestId == null && 
                        resource.data.status == "waiting" &&
                        request.resource.data.guestId is string)
                     ) &&
                     request.resource.data.hostId == resource.data.hostId;
      
      // 削除: 部屋のホストのみ削除可能
      allow delete: if false;
    }
    
    // その他のコレクションはデフォルトで拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 